<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Meus Anuncios — Mercado Insights</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <style>
    .anuncio-card:hover { box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15); transition: box-shadow 0.2s; }
  </style>
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">Mercado Insights</a>
    <span class="app-user">Ola, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html">Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html" class="active">Meus Anuncios</a>
        <a href="performance.html">Performance</a>
        <a href="concorrentes.html">Concorrentes</a>
        <a href="perguntas-anuncios.html">Perguntas nos anúncios</a>
        <a href="ia-assistente.html">IA Assistente</a>
        <a href="config-ml.html">⚙️ Config. Mercado Livre</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">⚙️ Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Meus Anuncios</h1>
      <p class="subtitle">Visualize seus anuncios e peca analise de descricao com IA para cada um.</p>
      
      <div id="ml-not-connected" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Conecte sua conta do Mercado Livre</h2>
          <p>Esta função estará disponível assim que você conectar sua conta do Mercado Livre.</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" id="btn-conectar-ml-page" class="button" style="cursor: pointer; border: none;">Conectar Mercado Livre</button>
            <a href="dashboard.html" class="button" style="text-decoration: none;">Ir para Dashboard</a>
          </div>
        </div>
      </div>

      <div id="upgrade-required" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Plano Pro necessário</h2>
          <p>Assine o plano para acessar Meus Anúncios e outras ferramentas.</p>
          <a href="dashboard.html" class="button" style="margin-top: 1rem;">Ver planos</a>
        </div>
      </div>

      <div id="loading" class="card" style="text-align: center; padding: 2rem;">
        <p>Carregando anúncios...</p>
      </div>

      <div id="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999; backdrop-filter: blur(2px);" onclick="closeAnuncioModal()"></div>
      <div id="anuncio-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 480px; width: 90%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation();">
        <div style="padding: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <h2 style="margin: 0; font-size: 1.25rem; color: var(--blue-primary);">Detalhes do anúncio</h2>
            <button type="button" onclick="closeAnuncioModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 1rem;">
            <p id="modal-title" style="margin: 0 0 0.5rem 0; font-weight: 600;"></p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: var(--gray); font-size: 0.9rem;">
              <span>ID: <strong id="modal-item-id"></strong></span>
              <span>Preço: <strong id="modal-price" style="color: var(--primary);"></strong></span>
              <span>Status: <strong id="modal-status"></strong></span>
              <span>Vendidos: <strong id="modal-sold"></strong></span>
              <span>Disponíveis: <strong id="modal-available"></strong></span>
            </div>
          </div>
          <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--gray-light);">
          <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem;">Custos e despesas (edite e salve)</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="font-size: 0.9rem; color: var(--gray);">Custo (R$)</span>
              <input type="text" id="modal-custo" inputmode="decimal" placeholder="0,00" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
            </label>
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="font-size: 0.9rem; color: var(--gray);">Embalagem (R$)</span>
              <input type="text" id="modal-embalagem" inputmode="decimal" value="0" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
            </label>
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="font-size: 0.9rem; color: var(--gray);">Frete (R$)</span>
              <input type="text" id="modal-frete" inputmode="decimal" value="0" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
            </label>
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="font-size: 0.9rem; color: var(--gray);">Taxa (%)</span>
              <input type="text" id="modal-taxa" inputmode="decimal" value="13" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
            </label>
            <label style="display: flex; flex-direction: column; gap: 0.25rem;">
              <span style="font-size: 0.9rem; color: var(--gray);">Imposto (%)</span>
              <input type="text" id="modal-imposto" inputmode="decimal" value="5" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 6px;">
            </label>
          </div>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button type="button" class="button" onclick="saveAnuncioCosts()">Salvar alterações</button>
            <a id="modal-link-ml" href="#" target="_blank" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-light); border-radius: 6px; text-decoration: none; color: var(--primary); font-size: 0.9rem;">Ver no ML</a>
            <a id="modal-link-edit" href="#" target="_blank" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-light); border-radius: 6px; text-decoration: none; color: var(--primary); font-size: 0.9rem;">Editar no ML</a>
          </div>
        </div>
      </div>

      <div id="anuncios-container" style="display: none;">
        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center;">
          <label for="status-filter">Filtrar por status:</label>
          <select id="status-filter" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
            <option value="all">Todos</option>
            <option value="active">Ativos</option>
            <option value="paused">Pausados</option>
            <option value="pending">Inativo para revisar</option>
            <option value="closed">Fechados</option>
          </select>
          <span id="total-count" style="margin-left: auto; color: var(--gray);"></span>
        </div>
        <div id="anuncios-list"></div>
        <div id="pagination" style="margin-top: 1rem; text-align: center;"></div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script>
    const API_BASE = window.location.origin;
    let currentStatus = 'all';
    let currentOffset = 0;
    const limit = 20;
    let currentItems = [];

    async function checkMLConnection(retries = 2) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await authFetch(API_BASE + '/api/ml-status');
          if (res.status === 401 && i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          const data = await res.json();
          return data.connected === true;
        } catch (e) {
          if (i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          console.error('Erro ao verificar conexão ML:', e);
          return false;
        }
      }
      return false;
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(price);
    }
    
    // Fix Mixed Content: force HTTPS for ML images
    function fixImageUrl(url) {
      if (!url) return '';
      return url.replace(/^http:\/\//i, 'https://');
    }

    function formatStatus(status) {
      const statusMap = {
        'active': 'Ativo',
        'paused': 'Pausado',
        'closed': 'Fechado',
        'payment_required': 'Pagamento Pendente',
        'under_review': 'Inativo para revisar',
        'pending': 'Inativo para revisar',
      };
      return statusMap[status] || (status ? String(status) : 'unknown');
    }

    function renderItem(item) {
      const thumbnail = item.pictures && item.pictures[0] ? item.pictures[0].url : '';
      const price = formatPrice(item.price || 0);
      const status = formatStatus(item.status || 'unknown');
      const soldQuantity = item.sold_quantity || 0;
      const availableQuantity = item.available_quantity || 0;
      const permalink = item.permalink || `https://produto.mercadolivre.com.br/${item.id}`;
      const editUrl = `https://www.mercadolivre.com.br/vender/editar-anuncio/${item.id}`;
      const itemId = (item.id || '').replace(/"/g, '').replace(/'/g, '&#39;');

      return `
        <div class="card anuncio-card" style="margin-bottom: 1rem; padding: 1rem; cursor: pointer;" data-item-id="${itemId}" onclick="openAnuncioModal(this.dataset.itemId)">
          <div style="display: flex; gap: 1rem;">
            ${thumbnail ? `<img src="${fixImageUrl(thumbnail)}" alt="${item.title}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px;">` : ''}
            <div style="flex: 1;">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">
                <span style="color: var(--primary); font-weight: 600;">${item.title || 'Sem título'}</span>
              </h3>
              <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <div>
                  <strong style="color: var(--primary); font-size: 1.2rem;">${price}</strong>
                </div>
                <div>
                  <span style="color: var(--gray);">Status: </span>
                  <span style="font-weight: 500;">${status}</span>
                </div>
                <div>
                  <span style="color: var(--gray);">Vendidos: </span>
                  <span>${soldQuantity}</span>
                </div>
                <div>
                  <span style="color: var(--gray);">Disponíveis: </span>
                  <span>${availableQuantity}</span>
                </div>
              </div>
              <div style="margin-top: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                <span style="color: var(--gray); font-size: 0.9rem;">ID: ${item.id}</span>
                <a href="${permalink}" target="_blank" onclick="event.stopPropagation();" style="font-size: 0.9rem; color: var(--primary);">Ver no ML</a>
                <a href="${editUrl}" target="_blank" onclick="event.stopPropagation();" style="font-size: 0.9rem; color: var(--primary);">Editar no ML</a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function openAnuncioModal(itemIdOrEl) {
      try {
        const id = typeof itemIdOrEl === 'string' ? itemIdOrEl : (itemIdOrEl && itemIdOrEl.dataset && itemIdOrEl.dataset.itemId);
        if (!id) return;
        const item = currentItems.find(i => i.id === id) || null;
        if (!item) return;
        const modal = document.getElementById('anuncio-modal');
        const overlay = document.getElementById('modal-overlay');
        if (!modal || !overlay) return;
        document.getElementById('modal-item-id').textContent = item.id || '-';
        document.getElementById('modal-title').textContent = item.title || 'Sem título';
        document.getElementById('modal-price').textContent = formatPrice(item.price || 0);
        document.getElementById('modal-status').textContent = formatStatus(item.status || 'unknown');
        document.getElementById('modal-sold').textContent = item.sold_quantity || 0;
        document.getElementById('modal-available').textContent = item.available_quantity || 0;
        document.getElementById('modal-custo').value = item.custo_produto != null ? String(item.custo_produto).replace('.', ',') : '';
        document.getElementById('modal-embalagem').value = item.embalagem != null ? String(item.embalagem).replace('.', ',') : '0';
        document.getElementById('modal-frete').value = item.frete != null ? String(item.frete).replace('.', ',') : '0';
        document.getElementById('modal-taxa').value = item.taxa_pct != null ? String(item.taxa_pct).replace('.', ',') : '13';
        document.getElementById('modal-imposto').value = item.imposto_pct != null ? String(item.imposto_pct).replace('.', ',') : '5';
        document.getElementById('modal-link-ml').href = item.permalink || `https://produto.mercadolivre.com.br/${item.id}`;
        document.getElementById('modal-link-edit').href = `https://www.mercadolivre.com.br/vender/editar-anuncio/${item.id}`;
        modal.dataset.itemId = item.id;
        modal.style.display = 'block';
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
      } catch (e) {
        console.error('Erro ao abrir modal:', e);
      }
    }

    function closeAnuncioModal() {
      const modal = document.getElementById('anuncio-modal');
      const overlay = document.getElementById('modal-overlay');
      if (modal) modal.style.display = 'none';
      if (overlay) overlay.style.display = 'none';
      document.body.style.overflow = '';
    }

    async function saveAnuncioCosts() {
      const modal = document.getElementById('anuncio-modal');
      if (!modal || !modal.dataset.itemId) return;
      const itemId = modal.dataset.itemId;
      const parseVal = (v) => {
        const s = String(v || '').trim().replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? null : n;
      };
      const upd = {
        item_id: itemId,
        custo_produto: parseVal(document.getElementById('modal-custo').value),
        embalagem: parseVal(document.getElementById('modal-embalagem').value) ?? 0,
        frete: parseVal(document.getElementById('modal-frete').value) ?? 0,
        taxa_pct: parseVal(document.getElementById('modal-taxa').value) ?? 13,
        imposto_pct: parseVal(document.getElementById('modal-imposto').value) ?? 5,
      };
      try {
        const res = await authFetch(API_BASE + '/api/financial-panel/costs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [upd] }),
        });
        if (!res.ok) throw new Error((await res.json()).detail || 'Erro');
        alert('Custos salvos!');
        closeAnuncioModal();
        loadAnuncios(currentStatus, currentOffset);
      } catch (e) {
        alert(e.message || 'Erro ao salvar.');
      }
    }

    async function loadAnuncios(status = 'active', offset = 0) {
      const loadingEl = document.getElementById('loading');
      const containerEl = document.getElementById('anuncios-container');
      const listEl = document.getElementById('anuncios-list');
      const notConnectedEl = document.getElementById('ml-not-connected');

      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      notConnectedEl.style.display = 'none';

      try {
        const res = await authFetch(`${API_BASE}/api/ml/items?status=${status}&limit=${limit}&offset=${offset}`);
        
        if (res.status === 403) {
          const errData = await res.json().catch(() => ({}));
          const isMlNotConnected = errData.detail === 'ml_not_connected';
          document.getElementById(isMlNotConnected ? 'ml-not-connected' : 'upgrade-required').style.display = 'block';
          loadingEl.style.display = 'none';
          return;
        }

        if (!res.ok) {
          throw new Error('Erro ao buscar anúncios');
        }

        const data = await res.json();
        const items = data.items || [];
        currentItems = items;
        const total = data.total || 0;

        if (items.length === 0) {
          listEl.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">Nenhum anúncio encontrado.</p>';
        } else {
          listEl.innerHTML = items.map(renderItem).join('');
        }

        document.getElementById('total-count').textContent = `${total} anúncio${total !== 1 ? 's' : ''}`;

        // Paginação
        const paginationEl = document.getElementById('pagination');
        if (total > limit) {
          const totalPages = Math.ceil(total / limit);
          const currentPage = Math.floor(offset / limit) + 1;
          
          let paginationHTML = '';
          if (currentPage > 1) {
            paginationHTML += `<button onclick="loadAnuncios('${status}', ${offset - limit})" style="padding: 0.5rem 1rem; margin: 0 0.25rem; border: 1px solid var(--gray-light); background: white; border-radius: 4px; cursor: pointer;">Anterior</button>`;
          }
          paginationHTML += `<span style="margin: 0 1rem;">Página ${currentPage} de ${totalPages}</span>`;
          if (currentPage < totalPages) {
            paginationHTML += `<button onclick="loadAnuncios('${status}', ${offset + limit})" style="padding: 0.5rem 1rem; margin: 0 0.25rem; border: 1px solid var(--gray-light); background: white; border-radius: 4px; cursor: pointer;">Próxima</button>`;
          }
          paginationEl.innerHTML = paginationHTML;
        } else {
          paginationEl.innerHTML = '';
        }

        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      } catch (e) {
        console.error('Erro ao carregar anúncios:', e);
        listEl.innerHTML = '<p style="text-align: center; color: var(--error); padding: 2rem;">Erro ao carregar anúncios. Tente novamente.</p>';
        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    function setupConectarMlButton() {
      const btn = document.getElementById('btn-conectar-ml-page');
      if (!btn) return;
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Redirecionando…';
        try {
          const u = await authFetch(API_BASE + '/api/ml-auth-url');
          const d = await u.json();
          if (u.ok && d.url) window.location.href = d.url;
          else alert(d.detail || 'Erro ao obter URL.');
        } catch (e) { alert('Erro: ' + (e.message || 'Não foi possível conectar.')); }
        btn.disabled = false;
        btn.textContent = 'Conectar Mercado Livre';
      };
    }

    async function init() {
      await initClerkAuth({ signInContainerId: 'clerk-signin', userButtonContainerId: 'clerk-user-button', appContentId: 'app-content' });
      
      if (!window.ClerkAuth?.signedIn) return;
      setupConectarMlButton();
      const connected = await checkMLConnection();
      if (!connected) {
        document.getElementById('ml-not-connected').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        return;
      }

      // Filtro de status
      document.getElementById('status-filter').addEventListener('change', (e) => {
        currentStatus = e.target.value;
        currentOffset = 0;
        loadAnuncios(currentStatus, currentOffset);
      });

      // Ler status da URL (ex: ?status=paused)
      const params = new URLSearchParams(window.location.search);
      const urlStatus = params.get('status');
      if (urlStatus && ['all', 'active', 'paused', 'closed'].includes(urlStatus)) {
        currentStatus = urlStatus;
        document.getElementById('status-filter').value = urlStatus;
      }

      loadAnuncios(currentStatus, currentOffset);
    }

    init();
  </script>
</body>
</html>
