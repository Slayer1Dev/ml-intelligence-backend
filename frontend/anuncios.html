<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Anuncios — ML Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">ML Intelligence</a>
    <span class="app-user">Ola, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html">Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html" class="active">Meus Anuncios</a>
        <a href="performance.html">Performance</a>
        <a href="concorrentes.html">Concorrentes</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">⚙️ Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Meus Anuncios</h1>
      <p class="subtitle">Visualize seus anuncios e peca analise de descricao com IA para cada um.</p>
      
      <div id="ml-not-connected" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Conecte sua conta do Mercado Livre</h2>
          <p>Esta funcao estara disponivel assim que voce conectar sua conta do Mercado Livre.</p>
          <a href="dashboard.html" class="button" style="margin-top: 1rem;">Ir para Dashboard</a>
        </div>
      </div>

      <div id="upgrade-required" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Plano Pro necessário</h2>
          <p>Assine o plano para acessar Meus Anúncios e outras ferramentas.</p>
          <a href="dashboard.html" class="button" style="margin-top: 1rem;">Ver planos</a>
        </div>
      </div>

      <div id="loading" class="card" style="text-align: center; padding: 2rem;">
        <p>Carregando anúncios...</p>
      </div>

      <div id="anuncios-container" style="display: none;">
        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center;">
          <label for="status-filter">Filtrar por status:</label>
          <select id="status-filter" style="padding: 0.5rem; border: 1px solid var(--gray-light); border-radius: 4px;">
            <option value="active">Ativos</option>
            <option value="paused">Pausados</option>
            <option value="closed">Fechados</option>
          </select>
          <span id="total-count" style="margin-left: auto; color: var(--gray);"></span>
        </div>
        <div id="anuncios-list"></div>
        <div id="pagination" style="margin-top: 1rem; text-align: center;"></div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script>
    const API_BASE = window.location.origin;
    let currentStatus = 'active';
    let currentOffset = 0;
    const limit = 20;

    async function checkMLConnection(retries = 2) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await authFetch(API_BASE + '/api/ml-status');
          if (res.status === 401 && i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          const data = await res.json();
          return data.connected === true;
        } catch (e) {
          if (i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          console.error('Erro ao verificar conexão ML:', e);
          return false;
        }
      }
      return false;
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(price);
    }

    function formatStatus(status) {
      const statusMap = {
        'active': 'Ativo',
        'paused': 'Pausado',
        'closed': 'Fechado',
        'payment_required': 'Pagamento Pendente',
      };
      return statusMap[status] || status;
    }

    function renderItem(item) {
      const thumbnail = item.pictures && item.pictures[0] ? item.pictures[0].url : '';
      const price = formatPrice(item.price || 0);
      const status = formatStatus(item.status || 'unknown');
      const soldQuantity = item.sold_quantity || 0;
      const availableQuantity = item.available_quantity || 0;
      const permalink = item.permalink || `https://produto.mercadolivre.com.br/${item.id}`;

      return `
        <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
          <div style="display: flex; gap: 1rem;">
            ${thumbnail ? `<img src="${thumbnail}" alt="${item.title}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 4px;">` : ''}
            <div style="flex: 1;">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">
                <a href="${permalink}" target="_blank" style="color: var(--primary); text-decoration: none;">${item.title || 'Sem título'}</a>
              </h3>
              <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <div>
                  <strong style="color: var(--primary); font-size: 1.2rem;">${price}</strong>
                </div>
                <div>
                  <span style="color: var(--gray);">Status: </span>
                  <span style="font-weight: 500;">${status}</span>
                </div>
                <div>
                  <span style="color: var(--gray);">Vendidos: </span>
                  <span>${soldQuantity}</span>
                </div>
                <div>
                  <span style="color: var(--gray);">Disponíveis: </span>
                  <span>${availableQuantity}</span>
                </div>
              </div>
              <div style="margin-top: 0.75rem;">
                <span style="color: var(--gray); font-size: 0.9rem;">ID: ${item.id}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadAnuncios(status = 'active', offset = 0) {
      const loadingEl = document.getElementById('loading');
      const containerEl = document.getElementById('anuncios-container');
      const listEl = document.getElementById('anuncios-list');
      const notConnectedEl = document.getElementById('ml-not-connected');

      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      notConnectedEl.style.display = 'none';

      try {
        const res = await authFetch(`${API_BASE}/api/ml/items?status=${status}&limit=${limit}&offset=${offset}`);
        
        if (res.status === 403) {
          const errData = await res.json().catch(() => ({}));
          const isMlNotConnected = errData.detail === 'ml_not_connected';
          document.getElementById(isMlNotConnected ? 'ml-not-connected' : 'upgrade-required').style.display = 'block';
          loadingEl.style.display = 'none';
          return;
        }

        if (!res.ok) {
          throw new Error('Erro ao buscar anúncios');
        }

        const data = await res.json();
        const items = data.items || [];
        const total = data.total || 0;

        if (items.length === 0) {
          listEl.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">Nenhum anúncio encontrado.</p>';
        } else {
          listEl.innerHTML = items.map(renderItem).join('');
        }

        document.getElementById('total-count').textContent = `${total} anúncio${total !== 1 ? 's' : ''}`;

        // Paginação
        const paginationEl = document.getElementById('pagination');
        if (total > limit) {
          const totalPages = Math.ceil(total / limit);
          const currentPage = Math.floor(offset / limit) + 1;
          
          let paginationHTML = '';
          if (currentPage > 1) {
            paginationHTML += `<button onclick="loadAnuncios('${status}', ${offset - limit})" style="padding: 0.5rem 1rem; margin: 0 0.25rem; border: 1px solid var(--gray-light); background: white; border-radius: 4px; cursor: pointer;">Anterior</button>`;
          }
          paginationHTML += `<span style="margin: 0 1rem;">Página ${currentPage} de ${totalPages}</span>`;
          if (currentPage < totalPages) {
            paginationHTML += `<button onclick="loadAnuncios('${status}', ${offset + limit})" style="padding: 0.5rem 1rem; margin: 0 0.25rem; border: 1px solid var(--gray-light); background: white; border-radius: 4px; cursor: pointer;">Próxima</button>`;
          }
          paginationEl.innerHTML = paginationHTML;
        } else {
          paginationEl.innerHTML = '';
        }

        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      } catch (e) {
        console.error('Erro ao carregar anúncios:', e);
        listEl.innerHTML = '<p style="text-align: center; color: var(--error); padding: 2rem;">Erro ao carregar anúncios. Tente novamente.</p>';
        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    async function init() {
      await initClerkAuth({ signInContainerId: 'clerk-signin', userButtonContainerId: 'clerk-user-button', appContentId: 'app-content' });
      
      if (!window.ClerkAuth?.signedIn) return;
      const connected = await checkMLConnection();
      if (!connected) {
        document.getElementById('ml-not-connected').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        return;
      }

      // Filtro de status
      document.getElementById('status-filter').addEventListener('change', (e) => {
        currentStatus = e.target.value;
        currentOffset = 0;
        loadAnuncios(currentStatus, currentOffset);
      });

      loadAnuncios(currentStatus, currentOffset);
    }

    init();
  </script>
</body>
</html>
