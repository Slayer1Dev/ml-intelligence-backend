<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Performance ‚Äî Mercado Insights</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <style>
    .chart-placeholder {
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.05) 0%, rgba(251, 191, 36, 0.1) 100%);
      border: 1px dashed rgba(30, 64, 175, 0.2);
      border-radius: 12px;
      padding: 4rem;
      margin-top: 1.5rem;
      text-align: center;
      color: var(--gray);
    }
  </style>
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">Mercado Insights</a>
    <span class="app-user">Ola, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html">Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html">Meus Anuncios</a>
        <a href="performance.html" class="active">Performance</a>
        <a href="concorrentes.html">Concorrentes</a>
        <a href="perguntas-anuncios.html">Perguntas nos an√∫ncios</a>
        <a href="ia-assistente.html">IA Assistente</a>
        <a href="config-ml.html">‚öôÔ∏è Config. Mercado Livre</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">‚öôÔ∏è Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Performance da Conta</h1>
      <p class="subtitle">Analises e graficos sobre vendas, visualizacoes e metricas da sua operacao.</p>
      
      <div id="ml-not-connected" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Conecte sua conta do Mercado Livre</h2>
          <p>Esta fun√ß√£o mostrar√° o desempenho da sua conta ap√≥s a integra√ß√£o com o Mercado Livre.</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" id="btn-conectar-ml-page" class="button" style="cursor: pointer; border: none;">Conectar Mercado Livre</button>
            <a href="dashboard.html" class="button" style="text-decoration: none;">Ir para Dashboard</a>
          </div>
        </div>
      </div>

      <div id="upgrade-required" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Plano Pro necess√°rio</h2>
          <p>Assine o plano para acessar Performance e outras ferramentas.</p>
          <a href="dashboard.html" class="button" style="margin-top: 1rem;">Ver planos</a>
        </div>
      </div>

      <div id="loading" class="card" style="text-align: center; padding: 2rem;">
        <p>Carregando m√©tricas...</p>
      </div>

      <div id="metrics-container" style="display: none;">
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          <a href="anuncios.html?status=active" class="card card-link" style="text-align: center; text-decoration: none; color: inherit;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="metric-active">-</div>
            <div style="color: var(--gray); font-size: 0.9rem;">An√∫ncios Ativos</div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--primary);">Ver lista ‚Üí</div>
          </a>
          <a href="anuncios.html?status=paused" class="card card-link" style="text-align: center; text-decoration: none; color: inherit;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è∏Ô∏è</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--warning);" id="metric-paused">-</div>
            <div style="color: var(--gray); font-size: 0.9rem;">Pausados / Inativo p/ revisar</div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--primary);">Ver lista ‚Üí</div>
          </a>
          <a href="anuncios.html?status=closed" class="card card-link" style="text-align: center; text-decoration: none; color: inherit;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--success);" id="metric-closed">-</div>
            <div style="color: var(--gray); font-size: 0.9rem;">An√∫ncios Fechados</div>
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--primary);">Ver lista ‚Üí</div>
          </a>
          <div class="card" style="text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí∞</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="metric-orders">-</div>
            <div style="color: var(--gray); font-size: 0.9rem;">Pedidos Pagos</div>
          </div>
        </div>

        <div class="card">
          <h2 style="margin-top: 0;">Resumo da Conta</h2>
          <div id="summary-content"></div>
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-light);">
            <a href="anuncios.html" class="button">Ver todos os an√∫ncios</a>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script>
    const API_BASE = window.location.origin;

    async function checkMLConnection(retries = 2) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await authFetch(API_BASE + '/api/ml-status');
          if (res.status === 401 && i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          const data = await res.json();
          return data.connected === true;
        } catch (e) {
          if (i < retries) {
            await new Promise(r => setTimeout(r, 1200));
            continue;
          }
          console.error('Erro ao verificar conex√£o ML:', e);
          return false;
        }
      }
      return false;
    }

    async function loadMetrics() {
      const loadingEl = document.getElementById('loading');
      const containerEl = document.getElementById('metrics-container');
      const notConnectedEl = document.getElementById('ml-not-connected');

      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      notConnectedEl.style.display = 'none';

      try {
        const res = await authFetch(API_BASE + '/api/ml/metrics');
        
        if (res.status === 403) {
          const errData = await res.json().catch(() => ({}));
          const isMlNotConnected = errData.detail === 'ml_not_connected';
          document.getElementById(isMlNotConnected ? 'ml-not-connected' : 'upgrade-required').style.display = 'block';
          loadingEl.style.display = 'none';
          return;
        }

        if (!res.ok) {
          throw new Error('Erro ao buscar m√©tricas');
        }

        const data = await res.json();
        const items = data.items || {};
        const orders = data.orders || {};

        document.getElementById('metric-active').textContent = items.active || 0;
        document.getElementById('metric-paused').textContent = items.paused || 0;
        document.getElementById('metric-closed').textContent = items.closed || 0;
        document.getElementById('metric-orders').textContent = orders.paid || 0;

        const summaryEl = document.getElementById('summary-content');
        summaryEl.innerHTML = `
          <div style="line-height: 2;">
            <p><strong>Total de An√∫ncios:</strong> ${items.total || 0}</p>
            <p><strong>An√∫ncios Ativos:</strong> ${items.active || 0} <span style="color: var(--gray); font-size: 0.9rem;">‚Äî vis√≠veis na vitrine</span></p>
            <p><strong>Pausados / Inativo para revisar:</strong> ${items.paused || 0} <span style="color: var(--gray); font-size: 0.9rem;">‚Äî exigem a√ß√£o</span></p>
            <p><strong>Fechados:</strong> ${items.closed || 0}</p>
            <p><strong>Pedidos Pagos:</strong> ${orders.paid || 0}</p>
          </div>
        `;

        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      } catch (e) {
        console.error('Erro ao carregar m√©tricas:', e);
        containerEl.innerHTML = '<p style="text-align: center; color: var(--error); padding: 2rem;">Erro ao carregar m√©tricas. Tente novamente.</p>';
        containerEl.style.display = 'block';
        loadingEl.style.display = 'none';
      }
    }

    function setupConectarMlButton() {
      const btn = document.getElementById('btn-conectar-ml-page');
      if (!btn) return;
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Redirecionando‚Ä¶';
        try {
          const u = await authFetch(API_BASE + '/api/ml-auth-url');
          const d = await u.json();
          if (u.ok && d.url) window.location.href = d.url;
          else alert(d.detail || 'Erro ao obter URL.');
        } catch (e) { alert('Erro: ' + (e.message || 'N√£o foi poss√≠vel conectar.')); }
        btn.disabled = false;
        btn.textContent = 'Conectar Mercado Livre';
      };
    }

    async function init() {
      await initClerkAuth({ signInContainerId: 'clerk-signin', userButtonContainerId: 'clerk-user-button', appContentId: 'app-content' });
      
      if (!window.ClerkAuth?.signedIn) return;
      setupConectarMlButton();
      const connected = await checkMLConnection();
      if (!connected) {
        document.getElementById('ml-not-connected').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        return;
      }

      loadMetrics();
    }

    init();
  </script>
</body>
</html>
