<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Assinatura e Pagamentos — Mercado Insights</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <style>
    .billing-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .billing-stat { text-align: center; }
    .billing-stat .label { font-size: 0.85rem; color: var(--gray); margin-bottom: 0.25rem; }
    .billing-stat .value { font-size: 1.3rem; font-weight: 700; color: var(--blue-primary); }
    .badge { display: inline-block; padding: 0.3rem 0.75rem; border-radius: 8px; font-weight: 600; font-size: 0.85rem; }
    .badge-active { background: #dcfce7; color: #166534; }
    .badge-canceled { background: #fef2f2; color: #991b1b; }
    .badge-pending { background: #fefce8; color: #854d0e; }
    .badge-free { background: var(--blue-light); color: var(--blue-primary); }
    .history-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(30,64,175,0.08); }
    .history-row:last-child { border-bottom: none; }
    .actions-row { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1.5rem; }
    .btn-danger { background: #dc2626; color: white; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1.25rem; border-radius: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: none; font-family: inherit; }
    .btn-danger:hover { background: #b91c1c; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(220,38,38,0.3); }
    .alert-banner { padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; font-weight: 500; }
    .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .alert-danger { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
  </style>
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">Mercado Insights</a>
    <span class="app-user">Olá, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html" data-paid>Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html" data-paid>Meus Anúncios</a>
        <a href="performance.html" data-paid>Performance</a>
        <a href="concorrentes.html" data-paid>Concorrentes</a>
        <a href="perguntas-anuncios.html" data-paid>Perguntas nos anúncios</a>
        <a href="ia-assistente.html" data-paid>IA Assistente</a>
        <a href="assinatura.html" class="active">Assinatura</a>
        <a href="config-ml.html">⚙️ Config. Mercado Livre</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">⚙️ Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Assinatura e Pagamentos</h1>
      <p class="subtitle">Acompanhe seu plano, histórico e gerencie sua assinatura.</p>

      <!-- Banner de alerta (exibido se necessário) -->
      <div id="alert-banner" style="display: none;"></div>

      <!-- Status da assinatura -->
      <div class="card" id="billing-card">
        <h3 style="margin-bottom: 1rem;">Seu plano</h3>
        <div class="billing-status" id="billing-status">
          <div class="billing-stat">
            <div class="label">Plano</div>
            <div class="value" id="stat-plan">—</div>
          </div>
          <div class="billing-stat">
            <div class="label">Status</div>
            <div class="value" id="stat-status">—</div>
          </div>
          <div class="billing-stat">
            <div class="label">Valor mensal</div>
            <div class="value" id="stat-amount">—</div>
          </div>
          <div class="billing-stat">
            <div class="label">Início</div>
            <div class="value" id="stat-started">—</div>
          </div>
          <div class="billing-stat">
            <div class="label">Próxima cobrança</div>
            <div class="value" id="stat-next">—</div>
          </div>
        </div>

        <div class="actions-row" id="billing-actions"></div>
      </div>

      <!-- Histórico -->
      <div class="card">
        <h3 style="margin-bottom: 1rem;">Histórico</h3>
        <div id="billing-history">
          <p style="color: var(--gray);">Carregando...</p>
        </div>
      </div>

      <!-- Links legais -->
      <div class="card" style="padding: 1rem 1.5rem;">
        <p style="font-size: 0.85rem; color: var(--gray);">
          Ao assinar, você concorda com nossos
          <a href="#" style="color: var(--blue-primary);">Termos de Uso</a> e
          <a href="#" style="color: var(--blue-primary);">Política de Privacidade</a>.
          Para dúvidas sobre cobranças, entre em contato pelo e-mail de suporte.
        </p>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script>
    const API_BASE = window.location.origin;

    function formatDate(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatCurrency(val) {
      if (val == null) return '—';
      return 'R$ ' + Number(val).toFixed(2).replace('.', ',');
    }

    function statusBadge(status) {
      const map = {
        'active': ['Ativa', 'badge-active'],
        'authorized': ['Ativa', 'badge-active'],
        'pending': ['Pendente', 'badge-pending'],
        'paused': ['Pausada', 'badge-pending'],
        'cancelled': ['Cancelada', 'badge-canceled'],
        'canceled': ['Cancelada', 'badge-canceled'],
        'no_subscription': ['Sem assinatura', 'badge-free'],
      };
      const [label, cls] = map[status] || [status, 'badge-free'];
      return '<span class="badge ' + cls + '">' + label + '</span>';
    }

    function planLabel(plan) {
      if (plan === 'pro_mensal') return 'Pro Mensal';
      if (plan === 'free') return 'Free';
      return plan || 'Free';
    }

    async function loadBilling() {
      try {
        const res = await authFetch(API_BASE + '/api/billing/status');
        const data = await res.json();

        document.getElementById('stat-plan').textContent = planLabel(data.plan);
        document.getElementById('stat-status').innerHTML = statusBadge(data.status);
        document.getElementById('stat-amount').textContent = formatCurrency(data.amount);
        document.getElementById('stat-started').textContent = formatDate(data.started_at);
        document.getElementById('stat-next').textContent = data.next_billing_at ? formatDate(data.next_billing_at) : (data.ends_at ? 'Encerrada em ' + formatDate(data.ends_at) : '—');

        // Banner de alerta
        const banner = document.getElementById('alert-banner');
        if (data.status === 'past_due' || data.status === 'paused') {
          banner.className = 'alert-banner alert-danger';
          banner.innerHTML = '⚠️ Sua assinatura está com pagamento pendente. Regularize para manter o acesso Pro.';
          banner.style.display = 'block';
        } else if (data.cancel_at_period_end) {
          banner.className = 'alert-banner alert-warning';
          banner.innerHTML = 'Sua assinatura foi cancelada e o acesso Pro encerra ao final do período.';
          banner.style.display = 'block';
        }

        // Ações
        const actionsEl = document.getElementById('billing-actions');
        let actionsHTML = '';
        if (data.status === 'no_subscription' || data.status === 'canceled' || data.status === 'cancelled') {
          actionsHTML += '<button type="button" class="button" id="btn-subscribe">Assinar Plano Pro</button>';
        }
        if (data.status === 'active' || data.status === 'authorized') {
          actionsHTML += '<button type="button" class="btn-danger" id="btn-cancel">Cancelar assinatura</button>';
        }
        actionsEl.innerHTML = actionsHTML;

        // Event listeners
        document.getElementById('btn-subscribe')?.addEventListener('click', doSubscribe);
        document.getElementById('btn-cancel')?.addEventListener('click', doCancel);

      } catch (e) {
        console.error('Erro ao carregar billing:', e);
      }
    }

    async function loadHistory() {
      try {
        const res = await authFetch(API_BASE + '/api/billing/history');
        const data = await res.json();
        const el = document.getElementById('billing-history');

        if (!data || data.length === 0) {
          el.innerHTML = '<p style="color: var(--gray);">Nenhum registro de assinatura encontrado.</p>';
          return;
        }

        let html = '';
        data.forEach(function(s) {
          html += '<div class="history-row">';
          html += '<div>';
          html += '<strong style="font-size: 0.95rem;">' + (s.subscription_id || 'ID não disponível') + '</strong>';
          html += '<div style="font-size: 0.85rem; color: var(--gray);">Início: ' + formatDate(s.started_at) + '</div>';
          html += '</div>';
          html += '<div style="text-align: right;">';
          html += statusBadge(s.status);
          if (s.ends_at) html += '<div style="font-size: 0.8rem; color: var(--gray); margin-top: 0.25rem;">Encerrada: ' + formatDate(s.ends_at) + '</div>';
          html += '</div>';
          html += '</div>';
        });
        el.innerHTML = html;
      } catch (e) {
        console.error('Erro ao carregar histórico:', e);
      }
    }

    async function doSubscribe() {
      const btn = document.getElementById('btn-subscribe');
      btn.disabled = true;
      btn.textContent = 'Redirecionando…';
      try {
        const res = await authFetch(API_BASE + '/api/create-checkout-session', { method: 'POST' });
        const data = await res.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Erro ao criar sessão de checkout. Tente novamente.');
          btn.disabled = false;
          btn.textContent = 'Assinar Plano Pro';
        }
      } catch (e) {
        alert('Erro de conexão. Tente novamente.');
        btn.disabled = false;
        btn.textContent = 'Assinar Plano Pro';
      }
    }

    async function doCancel() {
      if (!confirm('Tem certeza que deseja cancelar sua assinatura? Você perderá o acesso ao plano Pro.')) return;
      const btn = document.getElementById('btn-cancel');
      btn.disabled = true;
      btn.textContent = 'Cancelando…';
      try {
        const res = await authFetch(API_BASE + '/api/billing/cancel', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          alert('Assinatura cancelada com sucesso.');
          location.reload();
        } else {
          alert('Erro ao cancelar: ' + (data.detail || 'Tente novamente.'));
          btn.disabled = false;
          btn.textContent = 'Cancelar assinatura';
        }
      } catch (e) {
        alert('Erro de conexão. Tente novamente.');
        btn.disabled = false;
        btn.textContent = 'Cancelar assinatura';
      }
    }

    // Init
    initClerkAuth({
      signInContainerId: 'clerk-signin',
      userButtonContainerId: 'clerk-user-button',
      appContentId: 'app-content'
    });

    window.addEventListener('clerkReady', function() {
      loadBilling();
      loadHistory();
    });
  </script>
</body>
</html>
