<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Admin — ML Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">ML Intelligence</a>
    <span class="app-user">Admin</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">← Voltar</a>
        <hr style="margin: 0.5rem 0; border-color: var(--gray-light);">
        <a href="admin.html" class="active">Admin</a>
        <a href="#" data-tab="metrics">Métricas</a>
        <a href="#" data-tab="users">Usuários</a>
        <a href="#" data-tab="subscriptions">Assinaturas</a>
        <a href="#" data-tab="logs">Logs</a>
        <a href="#" data-tab="audit">Logs IA</a>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Painel Admin</h1>
      <p class="subtitle">Gestão de usuários, assinaturas e logs do sistema.</p>

      <div id="tab-metrics" class="tab-content" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom: 1rem;">Métricas do Sistema</h2>
          <div id="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">Carregando…</div>
        </div>
      </div>

      <div id="tab-users" class="tab-content" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom: 1rem;">Usuários</h2>
          <div id="users-list">Carregando…</div>
        </div>
      </div>

      <div id="tab-subscriptions" class="tab-content" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom: 1rem;">Assinaturas</h2>
          <div id="subscriptions-list">Carregando…</div>
        </div>
      </div>

      <div id="tab-logs" class="tab-content" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom: 0.5rem;">Logs do Backend</h2>
          <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 1rem;">Conteúdo de <code>logs/backend.log</code> (últimas 500 linhas). Atualize para ver novos eventos.</p>
          <div style="margin-bottom: 0.75rem;">
            <button type="button" id="btn-refresh-logs" class="button" style="font-size: 0.9rem;">Atualizar logs</button>
          </div>
          <pre id="logs-content" style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.8rem; max-height: 60vh; overflow-y: auto; white-space: pre-wrap; word-break: break-all; min-height: 120px;">Carregando…</pre>
        </div>
      </div>

      <div id="tab-audit" class="tab-content" style="display:none;">
        <div class="card">
          <h2 style="margin-bottom: 1rem;">Logs de IA (falhas e eventos)</h2>
          <div id="audit-list">Carregando…</div>
        </div>
      </div>

      <div id="tab-welcome" class="tab-content">
        <div class="card">
          <p style="color: var(--gray);">Selecione uma opção no menu ao lado.</p>
        </div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script>
    const API_BASE = window.location.origin;

    async function loadMetrics() {
      const el = document.getElementById('metrics-grid');
      try {
        const res = await authFetch(`${API_BASE}/api/admin/metrics`);
        if (!res.ok) { el.innerHTML = '<p style="color:red;">Erro ao carregar métricas.</p>'; return; }
        const m = await res.json();
        el.innerHTML = `
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;"><strong>Usuários totais</strong><div style="font-size: 1.5rem; color: var(--blue-primary);">${m.total_users || 0}</div></div>
          <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px;"><strong>Com plano ativo</strong><div style="font-size: 1.5rem; color: #22c55e;">${m.users_active_plan || 0}</div></div>
          <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;"><strong>Plano free</strong><div style="font-size: 1.5rem; color: #64748b;">${m.users_free_plan || 0}</div></div>
          <div style="padding: 1rem; background: #eff6ff; border-radius: 8px;"><strong>Assinaturas ativas</strong><div style="font-size: 1.5rem; color: #1e40af;">${m.subscriptions_active || 0}</div></div>
          <div style="padding: 1rem; background: #fef3c7; border-radius: 8px;"><strong>Contas ML conectadas</strong><div style="font-size: 1.5rem; color: #b45309;">${m.ml_accounts_connected || 0}</div></div>
        `;
      } catch (e) {
        el.innerHTML = '<p style="color:red;">Erro: ' + e.message + '</p>';
      }
    }

    async function updateUserPlan(userId, plan) {
      try {
        const res = await authFetch(`${API_BASE}/api/admin/users/${userId}/plan`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan })
        });
        if (!res.ok) { const d = await res.json(); throw new Error(d.detail || 'Erro'); }
        alert('Plano atualizado.');
        loadUsers();
      } catch (e) {
        alert('Erro: ' + e.message);
      }
    }

    async function loadUsers() {
      const el = document.getElementById('users-list');
      try {
        const res = await authFetch(`${API_BASE}/api/admin/users`);
        if (!res.ok) {
          if (res.status === 403) el.innerHTML = '<p style="color:red;">Acesso negado.</p>';
          else el.innerHTML = '<p style="color:red;">Erro ao carregar usuários.</p>';
          return;
        }
        const users = await res.json();
        if (users.length === 0) {
          el.innerHTML = '<p style="color:var(--gray);">Nenhum usuário cadastrado.</p>';
          return;
        }
        el.innerHTML = `
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr style="text-align:left; border-bottom: 1px solid var(--gray-light);">
                <th style="padding: 0.5rem;">Email</th>
                <th style="padding: 0.5rem;">Plano</th>
                <th style="padding: 0.5rem;">Ações</th>
                <th style="padding: 0.5rem;">Criado em</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 0.5rem;">${u.email || '-'}</td>
                  <td style="padding: 0.5rem;"><span style="background: ${u.plan === 'active' ? '#22c55e' : '#94a3b8'}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${u.plan}</span></td>
                  <td style="padding: 0.5rem;">
                    <button type="button" class="btn-plan" data-id="${u.id}" data-plan="active" ${u.plan === 'active' ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-right: 0.25rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: 1px solid #22c55e; background: #fff; color: #22c55e;">Pro</button>
                    <button type="button" class="btn-plan" data-id="${u.id}" data-plan="free" ${u.plan === 'free' ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: 1px solid #94a3b8; background: #fff; color: #64748b;">Free</button>
                  </td>
                  <td style="padding: 0.5rem; font-size: 0.85rem;">${u.created_at ? new Date(u.created_at).toLocaleString('pt-BR') : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        el.querySelectorAll('.btn-plan').forEach(btn => {
          btn.addEventListener('click', () => updateUserPlan(btn.dataset.id, btn.dataset.plan));
        });
      } catch (e) {
        el.innerHTML = '<p style="color:red;">Erro: ' + e.message + '</p>';
      }
    }

    async function loadSubscriptions() {
      const el = document.getElementById('subscriptions-list');
      try {
        const res = await authFetch(`${API_BASE}/api/admin/subscriptions`);
        if (!res.ok) {
          if (res.status === 403) el.innerHTML = '<p style="color:red;">Acesso negado.</p>';
          else el.innerHTML = '<p style="color:red;">Erro ao carregar assinaturas.</p>';
          return;
        }
        const subs = await res.json();
        if (subs.length === 0) {
          el.innerHTML = '<p style="color:var(--gray);">Nenhuma assinatura.</p>';
          return;
        }
        el.innerHTML = `
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr style="text-align:left; border-bottom: 1px solid var(--gray-light);">
                <th style="padding: 0.5rem;">Usuário</th>
                <th style="padding: 0.5rem;">Status</th>
                <th style="padding: 0.5rem;">Stripe ID</th>
                <th style="padding: 0.5rem;">Início</th>
                <th style="padding: 0.5rem;">Expira em</th>
              </tr>
            </thead>
            <tbody>
              ${subs.map(s => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 0.5rem;">${s.user_email || '-'}</td>
                  <td style="padding: 0.5rem;"><span style="background: ${s.status === 'active' ? '#22c55e' : '#94a3b8'}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${s.status}</span></td>
                  <td style="padding: 0.5rem; font-size: 0.8rem;">${s.stripe_subscription_id || '-'}</td>
                  <td style="padding: 0.5rem; font-size: 0.85rem;">${s.started_at ? new Date(s.started_at).toLocaleString('pt-BR') : '-'}</td>
                  <td style="padding: 0.5rem; font-size: 0.85rem;">${s.ends_at ? new Date(s.ends_at).toLocaleString('pt-BR') : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        el.innerHTML = '<p style="color:red;">Erro: ' + e.message + '</p>';
      }
    }

    async function loadAuditLogs() {
      const el = document.getElementById('audit-list');
      try {
        const res = await authFetch(`${API_BASE}/api/admin/audit-logs?limit=100`);
        if (!res.ok) { el.innerHTML = '<p style="color:red;">Erro ao carregar logs de IA.</p>'; return; }
        const logs = await res.json();
        if (logs.length === 0) {
          el.innerHTML = '<p style="color: var(--gray);">Nenhum evento registrado.</p>';
          return;
        }
        el.innerHTML = `
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr style="text-align:left; border-bottom: 1px solid var(--gray-light);">
                <th style="padding: 0.5rem;">Data</th>
                <th style="padding: 0.5rem;">Tipo</th>
                <th style="padding: 0.5rem;">Mensagem</th>
                <th style="padding: 0.5rem;">User ID</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(l => `
                <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 0.5rem; font-size: 0.85rem;">${l.created_at ? new Date(l.created_at).toLocaleString('pt-BR') : '-'}</td>
                  <td style="padding: 0.5rem;"><span style="background: #fef3c7; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${l.event_type || '-'}</span></td>
                  <td style="padding: 0.5rem; font-size: 0.85rem;">${(l.message || '-').substring(0, 80)}${(l.message || '').length > 80 ? '...' : ''}</td>
                  <td style="padding: 0.5rem;">${l.user_id || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        el.innerHTML = '<p style="color:red;">Erro: ' + e.message + '</p>';
      }
    }

    async function loadLogs() {
      const el = document.getElementById('logs-content');
      if (!el) return;
      el.textContent = 'Carregando…';
      el.style.color = '#e2e8f0';
      try {
        const res = await authFetch(`${API_BASE}/api/admin/logs`);
        const text = await res.text();
        el.textContent = (text && text.trim()) ? text : '(Arquivo de log vazio ou inexistente. O backend registra eventos em logs/backend.log.)';
        el.style.color = res.ok ? '#e2e8f0' : '#fca5a5';
        if (res.ok) el.scrollTop = el.scrollHeight;
      } catch (e) {
        el.textContent = 'Erro ao carregar logs: ' + (e.message || String(e));
        el.style.color = '#fca5a5';
      }
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.app-sidebar a[data-tab]').forEach(a => a.classList.remove('active'));
      const content = document.getElementById('tab-' + tabId);
      const link = document.querySelector(`a[data-tab="${tabId}"]`);
      if (content) content.style.display = 'block';
      if (link) link.classList.add('active');
      if (tabId === 'metrics') loadMetrics();
      if (tabId === 'users') loadUsers();
      if (tabId === 'subscriptions') loadSubscriptions();
      if (tabId === 'logs') loadLogs();
      if (tabId === 'audit') loadAuditLogs();
    }

    async function init() {
      const auth = await initClerkAuth({
        signInContainerId: 'clerk-signin',
        userButtonContainerId: 'clerk-user-button',
        appContentId: 'app-content',
      });
      if (!auth?.signedIn) return;

      const meRes = await authFetch(`${API_BASE}/api/me`);
      const me = await meRes.json();
      if (!me.isAdmin) {
        document.getElementById('app-content').innerHTML = '<div class="card"><p style="color:red;">Acesso restrito a administradores.</p><a href="dashboard.html">Voltar ao dashboard</a></div>';
        return;
      }

      document.querySelectorAll('a[data-tab]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          showTab(a.dataset.tab);
        });
      });
      document.getElementById('btn-refresh-logs')?.addEventListener('click', loadLogs);
    }

    init();
  </script>
</body>
</html>
