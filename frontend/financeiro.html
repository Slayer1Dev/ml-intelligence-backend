<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Painel Financeiro ‚Äî Mercado Insights</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <style>
    .upload-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    .metric-value { font-size: 1.6rem; font-weight: 700; color: var(--blue-primary); margin-top: 0.25rem; }
    .metric-label { color: var(--gray); font-size: 0.9rem; }
    .chart-card { padding: 1.5rem; }
    .cost-input { width: 70px; padding: 0.3rem; }
    #items-table td, #items-table th { padding: 0.5rem; font-size: 0.9rem; }
    .btn-primary-actions {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
      background: var(--blue-primary);
      color: white;
      font-size: 0.95rem;
    }
    .btn-primary-actions:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.35);
    }
    .btn-primary-actions:active { transform: translateY(0); }
    .btn-primary-actions.btn-insights { background: var(--yellow); color: var(--black); }
    .btn-primary-actions.btn-insights:hover { background: var(--yellow-hover); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); }
  </style>
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">Mercado Insights</a>
    <span class="app-user">Ol√°, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html" class="active">Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html">Meus An√∫ncios</a>
        <a href="performance.html">Performance</a>
        <a href="concorrentes.html">Concorrentes</a>
        <a href="perguntas-anuncios.html">Perguntas nos an√∫ncios</a>
        <a href="ia-assistente.html">IA Assistente</a>
        <a href="config-ml.html">‚öôÔ∏è Config. Mercado Livre</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">‚öôÔ∏è Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Painel Financeiro</h1>
      <p class="subtitle">Dados do Mercado Livre em tempo real. Cadastre custos por an√∫ncio e acompanhe lucro e margem.</p>

      <div class="tab-row">
        <button type="button" class="tab-btn active" data-tab="ml">Do Mercado Livre (API)</button>
        <button type="button" class="tab-btn" data-tab="planilha">Importar planilha</button>
        <button type="button" class="tab-btn" data-tab="analise">An√°lise por an√∫ncio</button>
      </div>

      <!-- Modo ML -->
      <div id="tab-ml" class="tab-content">
        <div id="ml-not-connected" class="card" style="display: none;">
          <p>Conecte sua conta do Mercado Livre para carregar os dados automaticamente.</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" id="btn-conectar-ml-page" class="button">Conectar Mercado Livre</button>
            <a href="dashboard.html" class="button" style="text-decoration: none;">Ir para Dashboard</a>
          </div>
        </div>
        <div id="ml-loaded" style="display: none;">
          <div class="card" style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
              <button type="button" id="btn-refresh-ml" class="btn-primary-actions">üîÑ Atualizar dados do ML</button>
              <button type="button" id="btn-ai-insights" class="btn-primary-actions btn-insights">‚ú® Insights de IA</button>
              <span id="last-update" style="color: var(--gray); font-size: 0.9rem;"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- An√°lise por an√∫ncio (ANALISE ANUNCIOS) -->
      <div id="tab-analise" class="tab-content" style="display: none;">
        <div class="card">
          <h3 style="margin-bottom: 1rem; color: var(--blue-primary);">An√°lise por an√∫ncio</h3>
          <p style="color: var(--gray); margin-bottom: 1rem;">Importe sua planilha ANALISE ANUNCIOS (formato CONTA 1 ML, CONTA 2 ML) com pesquisa de mercado, pre√ßos, vendas e a√ß√µes propostas.</p>
          <input type="file" id="analiseFile" accept=".xlsx,.xls" style="margin-bottom: 1rem;">
          <button type="button" id="btn-load-analise" class="btn-primary-actions">Carregar an√°lise</button>
        </div>
        <div id="analise-results" class="card" style="margin-top: 1rem; display: none;">
          <h3 style="margin-bottom: 1rem; color: var(--blue-primary);">Resultados da an√°lise</h3>
          <div class="table-wrap" style="overflow-x: auto;">
            <table class="table" id="analise-table">
              <thead>
                <tr>
                  <th>SKU</th><th>Descri√ß√£o</th><th>Custo</th><th>Pre√ßo m√©dio</th><th>Margem %</th><th>Lucro</th>
                  <th>Pre√ßo mais barato</th><th>Pre√ßo mais caro</th><th>Pre√ßo atual</th>
                  <th>Valor mais vendido</th><th>Vendas m√™s</th><th>OBS</th><th>A√ß√µes propostas</th><th>Aten√ß√£o</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modo planilha -->
      <div id="tab-planilha" class="tab-content" style="display: none;">
        <div class="card">
          <h3 style="margin-bottom: 1rem; color: var(--blue-primary);">Importar dados</h3>
          <form id="financeForm" class="upload-grid">
            <div class="form-group">
              <label>Planilha do Mercado Livre (XLSX)</label>
              <input type="file" id="mlFile" accept=".xlsx" required>
            </div>
            <div class="form-group">
              <label>Planilha de custos (opcional)</label>
              <input type="file" id="costFile" accept=".xlsx,.csv">
            </div>
            <div class="form-group">
              <label>Embalagem (R$)</label>
              <input type="text" inputmode="decimal" id="embalagem" value="1">
            </div>
            <div class="form-group">
              <label>Frete (R$)</label>
              <input type="text" inputmode="decimal" id="frete" value="0">
            </div>
            <div class="form-group" style="align-self: end;">
              <button type="submit" class="btn btn-primary" style="width: 100%;">Gerar Painel</button>
            </div>
          </form>
        </div>
      </div>

      <p id="financeError" style="margin-top: 1rem; color: #dc2626; display: none;"></p>

      <div id="metricsSection" style="display: none;">
        <div class="grid">
          <div class="card"><div class="metric-label">An√∫ncios totais</div><div class="metric-value" id="metricTotal">-</div></div>
          <div class="card"><div class="metric-label">An√∫ncios ativos</div><div class="metric-value" id="metricActive">-</div></div>
          <div class="card"><div class="metric-label">Estoque total</div><div class="metric-value" id="metricStock">-</div></div>
          <div class="card"><div class="metric-label">Pre√ßo m√©dio (R$)</div><div class="metric-value" id="metricPrice">-</div></div>
          <div class="card"><div class="metric-label">Taxa m√©dia (%)</div><div class="metric-value" id="metricFee">-</div></div>
          <div class="card"><div class="metric-label">Lucro m√©dio (R$)</div><div class="metric-value" id="metricProfitMean">-</div></div>
          <div class="card"><div class="metric-label">Margem m√©dia (%)</div><div class="metric-value" id="metricMarginMean">-</div></div>
          <div class="card"><div class="metric-label">Lucro total (R$)</div><div class="metric-value" id="metricProfitTotal">-</div></div>
          <div class="card"><div class="metric-label">Itens sem custo</div><div class="metric-value" id="metricMissingCost">-</div></div>
        </div>

        <div class="card chart-card" style="margin-top: 1.5rem; min-height: 180px;">
          <h3 style="margin-bottom: 1rem; color: var(--blue-primary);">Top 10 por lucro</h3>
          <div id="chart-placeholder" style="display: none; color: var(--gray); padding: 2rem; text-align: center;">Cadastre custos para ver o gr√°fico de lucro.</div>
          <div id="chart-container" style="position: relative; height: 220px;">
            <canvas id="profitChart"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin-bottom: 1rem; color: var(--blue-primary);">An√∫ncios e custos (edite e salve)</h3>
          <div id="profit-table-simple" style="display: none;">
            <table class="table" id="profitTable"><thead><tr><th>SKU</th><th>T√≠tulo</th><th>Pre√ßo</th><th>Lucro</th><th>Margem</th></tr></thead><tbody></tbody></table>
          </div>
          <div class="table-wrap" style="overflow-x: auto;" id="items-table-wrap">
            <table class="table" id="items-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>T√≠tulo</th>
                  <th>Pre√ßo</th>
                  <th>Custo (R$)</th>
                  <th>Embalagem</th>
                  <th>Frete</th>
                  <th>Taxa %</th>
                  <th>Imposto %</th>
                  <th>Lucro</th>
                  <th>Margem</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <button type="button" id="btn-save-costs" class="button" style="margin-top: 1rem; display: none;">Salvar altera√ß√µes</button>
        </div>

        <div id="ai-insights-box" class="card" style="margin-top: 1.5rem; display: none;">
          <h3 style="margin-bottom: 1rem;">Insights de IA</h3>
          <div id="ai-insights-content"></div>
        </div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_URL = window.location.origin;
    let chart;
    let currentPanelData = null;

    function parseNum(val) {
      if (val === '' || val === null || val === undefined) return null;
      const s = String(val).trim().replace(',', '.');
      const n = parseFloat(s);
      return isNaN(n) ? null : n;
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function fmt(v) {
      if (v == null) return '-';
      return typeof v === 'number' ? v.toFixed(2).replace('.', ',') : v;
    }

    function renderMetrics(m) {
      setText('metricTotal', m.total_listings);
      setText('metricActive', m.active_listings);
      setText('metricStock', m.total_stock);
      setText('metricPrice', `R$ ${fmt(m.avg_price)}`);
      setText('metricFee', `${fmt(m.avg_fee_pct)}%`);
      setText('metricProfitMean', `R$ ${fmt(m.profit_mean)}`);
      setText('metricMarginMean', `${fmt(m.margin_mean)}%`);
      setText('metricProfitTotal', `R$ ${fmt(m.profit_total)}`);
      setText('metricMissingCost', m.missing_cost || 0);
    }

    function renderChart(topProfit) {
      const data = topProfit || [];
      const placeholder = document.getElementById('chart-placeholder');
      const container = document.getElementById('chart-container');
      const ctx = document.getElementById('profitChart');
      if (!ctx) return;
      if (chart) chart.destroy();
      chart = null;
      if (data.length === 0) {
        if (placeholder) placeholder.style.display = 'block';
        if (container) container.style.display = 'none';
        return;
      }
      if (placeholder) placeholder.style.display = 'none';
      if (container) container.style.display = 'block';
      const labels = data.map(r => (r.SKU_STR || r.ITEM_ID || r.TITLE || '-').toString().substring(0, 18));
      const values = data.map(r => r.PROFIT || 0);
      const maxVal = Math.max(...values, 1);
      const barThickness = data.length <= 3 ? 36 : Math.min(48, Math.max(20, 280 / data.length));
      chart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Lucro (R$)', data: values, backgroundColor: 'rgba(30, 64, 175, 0.85)', barThickness, maxBarThickness: 60 }] },
        options: {
          indexAxis: data.length <= 4 ? 'y' : 'x',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              max: maxVal * 1.2,
              ticks: { callback: v => 'R$ ' + (typeof v === 'number' ? v.toLocaleString('pt-BR') : v) }
            },
            x: {
              ticks: { maxRotation: data.length <= 6 ? 0 : 45, font: { size: 11 } }
            }
          }
        }
      });
    }

    function renderItemsTable(items) {
      const tbody = document.querySelector('#items-table tbody');
      if (!tbody) return;
      tbody.innerHTML = (items || []).map(it => `
        <tr>
          <td>${it.sku || '-'}</td>
          <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;">${(it.title || '-').substring(0, 40)}</td>
          <td>R$ ${fmt(it.price)}</td>
          <td><input type="text" class="cost-input" data-item="${it.id}" data-field="custo_produto" value="${fmt(it.custo_produto)}" placeholder="0"></td>
          <td><input type="text" class="cost-input" data-item="${it.id}" data-field="embalagem" value="${fmt(it.embalagem)}"></td>
          <td><input type="text" class="cost-input" data-item="${it.id}" data-field="frete" value="${fmt(it.frete)}"></td>
          <td><input type="text" class="cost-input" data-item="${it.id}" data-field="taxa_pct" value="${fmt(it.taxa_pct)}"></td>
          <td><input type="text" class="cost-input" data-item="${it.id}" data-field="imposto_pct" value="${fmt(it.imposto_pct)}"></td>
          <td>${it.profit != null ? 'R$ ' + fmt(it.profit) : '-'}</td>
          <td>${it.margin_pct != null ? fmt(it.margin_pct) + '%' : '-'}</td>
        </tr>
      `).join('');
    }

    async function loadFromML() {
      const err = document.getElementById('financeError');
      err.style.display = 'none';
      try {
        const res = await authFetch(`${API_URL}/api/financial-panel`);
        if (res.status === 403) {
          document.getElementById('ml-not-connected').style.display = 'block';
          document.getElementById('ml-loaded').style.display = 'none';
          return;
        }
        if (!res.ok) throw new Error((await res.json()).detail || 'Erro');
        const data = await res.json();
        currentPanelData = data;
        document.getElementById('ml-not-connected').style.display = 'none';
        document.getElementById('ml-loaded').style.display = 'block';
        document.getElementById('last-update').textContent = 'Atualizado agora';
        renderMetrics(data.metrics);
        renderChart(data.top_profit);
        renderItemsTable(data.items);
        document.getElementById('metricsSection').style.display = 'block';
        document.getElementById('items-table-wrap').style.display = 'block';
        document.getElementById('btn-save-costs').style.display = 'inline-block';
        document.getElementById('profit-table-simple').style.display = 'none';
        document.getElementById('profit-table-simple').style.display = 'none';
      } catch (e) {
        err.textContent = e.message || 'Erro ao carregar.';
        err.style.display = 'block';
      }
    }

    document.getElementById('btn-refresh-ml')?.addEventListener('click', loadFromML);
    document.getElementById('btn-save-costs')?.addEventListener('click', async () => {
      const inputs = document.querySelectorAll('#items-table input[data-item][data-field]');
      const byItem = {};
      inputs.forEach(inp => {
        const id = inp.dataset.item;
        const field = inp.dataset.field;
        const val = parseNum(inp.value);
        if (!byItem[id]) byItem[id] = { item_id: id };
        if (val !== null) byItem[id][field === 'custo_produto' ? 'custo_produto' : field] = val;
      });
      const items = Object.values(byItem).filter(x => Object.keys(x).length > 1);
      if (items.length === 0) { alert('Nenhuma altera√ß√£o para salvar.'); return; }
      try {
        const res = await authFetch(`${API_URL}/api/financial-panel/costs`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });
        if (!res.ok) throw new Error((await res.json()).detail || 'Erro');
        alert('Custos salvos!');
        loadFromML();
      } catch (e) {
        document.getElementById('financeError').textContent = e.message;
        document.getElementById('financeError').style.display = 'block';
      }
    });

    document.getElementById('btn-ai-insights')?.addEventListener('click', async () => {
      const box = document.getElementById('ai-insights-box');
      const content = document.getElementById('ai-insights-content');
      content.innerHTML = '<p>Gerando insights...</p>';
      box.style.display = 'block';
      try {
        const res = await authFetch(`${API_URL}/api/financial-panel/ai-insights`, { method: 'POST' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Erro');
        let html = '';
        if (data.resumo) html += `<p><strong>Resumo:</strong> ${data.resumo}</p>`;
        if (data.alertas?.length) html += `<p><strong>Alertas:</strong><ul>${data.alertas.map(a => '<li>' + a + '</li>').join('')}</ul></p>`;
        if (data.sugestoes?.length) html += `<p><strong>Sugest√µes:</strong><ul>${data.sugestoes.map(s => '<li>' + s + '</li>').join('')}</ul></p>`;
        if (data.top_oportunidades?.length) html += `<p><strong>Oportunidades:</strong><ul>${data.top_oportunidades.map(o => '<li>' + o + '</li>').join('')}</ul></p>`;
        content.innerHTML = html || '<p>Nenhum insight dispon√≠vel.</p>';
      } catch (e) {
        content.innerHTML = '<p style="color:red;">' + (e.message || 'Erro ao gerar insights.') + '</p>';
      }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('tab-' + tab).style.display = 'block';
        if (tab === 'ml') loadFromML();
      });
    });

    document.getElementById('btn-load-analise')?.addEventListener('click', async () => {
      const file = document.getElementById('analiseFile').files[0];
      if (!file) { alert('Selecione um arquivo XLSX.'); return; }
      const btn = document.getElementById('btn-load-analise');
      btn.disabled = true;
      try {
        const form = new FormData();
        form.append('file', file);
        const res = await authFetch(`${API_URL}/api/analise-anuncios`, { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Erro');
        const items = data.items || [];
        const tbody = document.querySelector('#analise-table tbody');
        tbody.innerHTML = items.map(it => `
          <tr>
            <td>${it.sku || '-'}</td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">${(it.descricao || '-').substring(0, 40)}</td>
            <td>${it.custo != null ? 'R$ ' + fmt(it.custo) : '-'}</td>
            <td>${it.preco_medio != null ? 'R$ ' + fmt(it.preco_medio) : '-'}</td>
            <td>${it.margem_pct != null ? fmt(it.margem_pct) + '%' : '-'}</td>
            <td>${it.lucro != null ? 'R$ ' + fmt(it.lucro) : '-'}</td>
            <td>${it.preco_mais_barato != null ? 'R$ ' + fmt(it.preco_mais_barato) : '-'}</td>
            <td>${it.preco_mais_caro != null ? 'R$ ' + fmt(it.preco_mais_caro) : '-'}</td>
            <td>${it.preco_atual != null ? 'R$ ' + fmt(it.preco_atual) : '-'}</td>
            <td style="max-width:100px;">${(String(it.valor_mais_vendido || '-')).substring(0, 30)}</td>
            <td>${it.vendas_mes || '-'}</td>
            <td style="max-width:120px;">${(String(it.obs || '-')).substring(0, 40)}</td>
            <td style="max-width:120px;">${(String(it.acoes_propostas || '-')).substring(0, 40)}</td>
            <td>${it.atencao || '-'}</td>
          </tr>
        `).join('');
        document.getElementById('analise-results').style.display = 'block';
      } catch (e) {
        alert(e.message || 'Erro ao carregar.');
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('financeForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const err = document.getElementById('financeError');
      err.style.display = 'none';
      const mlFile = document.getElementById('mlFile').files[0];
      if (!mlFile) { err.textContent = 'Envie a planilha.'; err.style.display = 'block'; return; }
      const form = new FormData();
      form.append('file', mlFile);
      const costFile = document.getElementById('costFile').files[0];
      if (costFile) form.append('costs_file', costFile);
      form.append('embalagem', parseNum(document.getElementById('embalagem').value) ?? 1);
      form.append('frete', parseNum(document.getElementById('frete').value) ?? 0);
      try {
        const res = await authFetch(`${API_URL}/api/financial-dashboard`, { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Erro');
        const m = data.metrics;
        renderMetrics({ total_listings: m.total_listings, active_listings: m.active_listings, total_stock: m.total_stock, avg_price: m.avg_price, avg_fee_pct: m.avg_fee_pct, profit_mean: m.profit_mean, margin_mean: m.margin_mean, profit_total: m.profit_total, missing_cost: m.missing_cost });
        renderChart(data.top_profit);
        document.getElementById('metricsSection').style.display = 'block';
        document.getElementById('items-table-wrap').style.display = 'none';
        document.getElementById('btn-save-costs').style.display = 'none';
        document.getElementById('profit-table-simple').style.display = 'block';
        const tbody = document.querySelector('#profitTable tbody');
        tbody.innerHTML = (data.top_profit || []).map(r => `
          <tr><td>${r.SKU_STR || '-'}</td><td>${(r.TITLE || '-').substring(0, 40)}</td><td>R$ ${fmt(r.PRICE_NUM)}</td><td>R$ ${fmt(r.PROFIT)}</td><td>${fmt(r.MARGIN_PCT)}%</td></tr>
        `).join('');
      } catch (error) {
        err.textContent = error.message || 'Falha ao gerar painel.';
        err.style.display = 'block';
      }
    });

    function setupConectarMlButton() {
      const btn = document.getElementById('btn-conectar-ml-page');
      if (!btn) return;
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Redirecionando‚Ä¶';
        try {
          const u = await authFetch(API_URL + '/api/ml-auth-url');
          const d = await u.json();
          if (u.ok && d.url) window.location.href = d.url;
          else alert(d.detail || 'Erro ao obter URL.');
        } catch (e) { alert('Erro: ' + (e.message || 'N√£o foi poss√≠vel conectar.')); }
        btn.disabled = false;
        btn.textContent = 'Conectar Mercado Livre';
      };
    }

    async function init() {
      await initClerkAuth({ signInContainerId: 'clerk-signin', userButtonContainerId: 'clerk-user-button', appContentId: 'app-content' });
      if (!window.ClerkAuth?.signedIn) return;
      setupConectarMlButton();
      const mlRes = await authFetch(`${API_URL}/api/ml-status`);
      const ml = await mlRes.json().catch(() => ({}));
      if (ml.connected) loadFromML();
      else document.getElementById('ml-not-connected').style.display = 'block';
    }
    init();
  </script>
</body>
</html>
