<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png">
  <title>Concorrentes ‚Äî Mercado Insights</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
  <style>
    .search-box { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .search-box input { flex: 1; min-width: 200px; padding: 0.75rem 1rem; border: 1px solid var(--gray-light); border-radius: 8px; font-size: 1rem; }
    .search-box input:focus { outline: none; border-color: var(--primary); }
    .btn-concorrentes {
      padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none;
      background: var(--blue-primary); color: white; font-size: 0.95rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-concorrentes:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.35); }
    .btn-concorrentes:active { transform: translateY(0); }
    .btn-concorrentes:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .compare-section { background: var(--blue-light, #eff6ff); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .result-row { display: flex; gap: 1rem; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; }
    .result-row:last-child { border-bottom: none; }
    .result-row.mine { background: rgba(30, 64, 175, 0.08); border-radius: 8px; margin: 0.25rem 0; }
    .result-row .thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; }
    .result-row .pos { font-weight: 700; color: var(--primary); min-width: 2rem; }
    .result-row .info { flex: 1; }
    .result-row .price { font-weight: 600; color: var(--primary); }
    .badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: #22c55e; color: white; }
  </style>
</head>
<body class="app">
  <header class="app-header">
    <a href="dashboard.html" class="app-logo">Mercado Insights</a>
    <span class="app-user">Ol√°, vendedor</span>
    <div id="clerk-user-button"></div>
  </header>

  <div id="clerk-signin" style="display:none;"></div>

  <div id="app-content" class="app-body">
    <aside class="app-sidebar">
      <nav>
        <a href="dashboard.html">Resumo</a>
        <a href="financeiro.html">Painel Financeiro</a>
        <a href="calculator.html">Calculadora de Lucro</a>
        <a href="anuncios.html">Meus An√∫ncios</a>
        <a href="performance.html">Performance</a>
        <a href="concorrentes.html" class="active">Concorrentes</a>
        <a href="perguntas-anuncios.html">Perguntas nos an√∫ncios</a>
        <a href="ia-assistente.html">IA Assistente</a>
        <a href="config-ml.html">‚öôÔ∏è Config. Mercado Livre</a>
        <span id="admin-link-wrap" style="display:none;"><hr style="margin: 0.5rem 0; border-color: var(--gray-light);"><a href="admin.html">‚öôÔ∏è Admin</a></span>
      </nav>
    </aside>

    <main class="app-main">
      <h1>Concorrentes</h1>
      <p class="subtitle">Busque concorrentes no marketplace e compare seu an√∫ncio com os l√≠deres.</p>

      <div id="ml-not-connected" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Conecte sua conta do Mercado Livre</h2>
          <p>Para comparar seus an√∫ncios com concorrentes, conecte sua conta primeiro. A busca por termo est√° dispon√≠vel abaixo.</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" id="btn-conectar-ml-page" class="button">Conectar Mercado Livre</button>
            <a href="dashboard.html" class="button" style="text-decoration: none;">Ir para Dashboard</a>
          </div>
        </div>
      </div>

      <div id="upgrade-required" class="card" style="display: none;">
        <div class="coming-soon">
          <h2>Plano Pro necess√°rio</h2>
          <p>Assine o plano para acessar Concorrentes.</p>
          <a href="dashboard.html" class="button" style="margin-top: 1rem;">Ver planos</a>
        </div>
        <div id="admin-diagnostic" style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: var(--gray); display: none;">
          <strong>Diagn√≥stico (admin):</strong>
          <p id="admin-diagnostic-text" style="margin: 0.5rem 0 0 0; white-space: pre-wrap;"></p>
        </div>
      </div>

      <div id="concorrentes-container" style="display: none;">
        <!-- Adicionar concorrente por link (funciona mesmo com busca 403) -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <h2 style="margin-top: 0;">Adicionar concorrente por link ou ID</h2>
          <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 1rem;">Cole a URL do an√∫ncio no Mercado Livre ou o ID (ex: MLB123456) para acompanhar um concorrente.</p>
          <div class="search-box">
            <input type="text" id="competitor-url-input" placeholder="https://produto.mercadolivre.com.br/... ou MLB123456" style="flex: 1; min-width: 200px;">
            <button type="button" id="btn-add-competitor" class="btn-concorrentes">Adicionar</button>
          </div>
          <div id="competitor-add-msg" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
        </div>

        <!-- Lista de concorrentes cadastrados -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <h2 style="margin-top: 0;">Meus concorrentes cadastrados</h2>
          <div id="competitors-list"></div>
        </div>

        <!-- Busca por termo -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <h2 style="margin-top: 0;">Buscar concorrentes por termo</h2>
          <p style="color: var(--gray); font-size: 0.85rem; margin-bottom: 0.5rem;">A busca por termo pode estar restrita pelo ML. <strong>Use o campo acima para adicionar concorrentes por link ou ID</strong> ‚Äî funciona sem certifica√ß√£o.</p>
          <div class="search-box">
            <input type="text" id="search-input" placeholder="Ex: fone bluetooth, notebook gamer..." autocomplete="off">
            <select id="sort-select" style="padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 8px;">
              <option value="">Relev√¢ncia</option>
              <option value="price_asc">Menor pre√ßo</option>
              <option value="price_desc">Maior pre√ßo</option>
              <option value="sales_desc">Mais vendidos</option>
            </select>
            <button type="button" id="btn-search" class="btn-concorrentes">Buscar</button>
          </div>
        </div>

        <!-- Comparar meu an√∫ncio (se ML conectado) -->
        <div id="compare-section" class="compare-section" style="display: none;">
          <h3 style="margin-top: 0;">Comparar meu an√∫ncio</h3>
          <p style="color: var(--gray); margin-bottom: 1rem;">Selecione um dos seus an√∫ncios para ver sua posi√ß√£o na busca.</p>
          <div class="search-box">
            <select id="my-items-select" style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: 8px;">
              <option value="">Carregando seus an√∫ncios...</option>
            </select>
            <button type="button" id="btn-compare" class="btn-concorrentes">Comparar</button>
          </div>
        </div>

        <!-- Resultados da busca -->
        <div id="results-area" style="display: none;">
          <div class="card">
            <h2 style="margin-top: 0;">Resultados da busca</h2>
            <p id="results-meta" style="color: var(--gray); margin-bottom: 1rem;"></p>
            <div id="results-list"></div>
            <div id="results-pagination" style="margin-top: 1rem; text-align: center;"></div>
          </div>
        </div>

        <!-- Resultados da compara√ß√£o -->
        <div id="compare-results-area" style="display: none;">
          <div class="card">
            <h2 style="margin-top: 0;">Compara√ß√£o: <span id="compare-title"></span></h2>
            <div id="compare-summary" style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;"></div>
            <div id="compare-list"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="clerk-auth.js"></script>
  <script src="app-nav.js"></script>
  <script>
    const API_BASE = window.location.origin;
    let mlConnected = false;
    let searchOffset = 0;
    const limit = 20;

    function formatPrice(p) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p || 0);
    }
    
    // Fix Mixed Content: force HTTPS for ML images
    function fixImageUrl(url) {
      if (!url) return '';
      return url.replace(/^http:\/\//i, 'https://');
    }

    async function checkAccess() {
      try {
        const [meRes, mlRes] = await Promise.all([
          authFetch(API_BASE + '/api/me'),
          authFetch(API_BASE + '/api/ml-status'),
        ]);
        const me = await meRes.json();
        const ml = await mlRes.json();
        const hasPlan = me.plan === 'active' || me.isAdmin;
        mlConnected = ml.connected === true;

        if (!hasPlan) {
          document.getElementById('upgrade-required').style.display = 'block';
          loadAdminDiagnostic();
          return false;
        }
        document.getElementById('concorrentes-container').style.display = 'block';
        if (mlConnected) {
          document.getElementById('compare-section').style.display = 'block';
          loadMyItems();
          loadCompetitors();
        } else {
          document.getElementById('ml-not-connected').style.display = 'block';
        }
        return true;
      } catch (e) {
        console.error(e);
        document.getElementById('upgrade-required').style.display = 'block';
        loadAdminDiagnostic();
        return false;
      }
    }

    function setupConectarMlButton() {
      const btn = document.getElementById('btn-conectar-ml-page');
      if (!btn) return;
      btn.onclick = async () => {
        btn.disabled = true;
        btn.textContent = 'Redirecionando‚Ä¶';
        try {
          const u = await authFetch(API_BASE + '/api/ml-auth-url');
          const d = await u.json();
          if (u.ok && d.url) window.location.href = d.url;
          else alert(d.detail || 'Erro ao obter URL.');
        } catch (e) { alert('Erro: ' + (e.message || 'N√£o foi poss√≠vel conectar.')); }
        btn.disabled = false;
        btn.textContent = 'Conectar Mercado Livre';
      };
    }

    async function loadAdminDiagnostic() {
      const box = document.getElementById('admin-diagnostic');
      const text = document.getElementById('admin-diagnostic-text');
      if (!box || !text) return;
      try {
        const res = await authFetch(API_BASE + '/api/debug-admin');
        const d = await res.json();
        box.style.display = 'block';
        text.textContent = [
          'Email que o sistema reconhece: ' + (d.seu_email || '(vazio)'),
          'isAdmin: ' + d.isAdmin,
          'Dica: ' + (d.dica || '')
        ].join('\n');
      } catch (e) {
        box.style.display = 'block';
        text.textContent = 'N√£o foi poss√≠vel carregar o diagn√≥stico. Fa√ßa login novamente.';
      }
    }

    async function loadMyItems() {
      const sel = document.getElementById('my-items-select');
      try {
        const res = await authFetch(API_BASE + '/api/ml/items?status=all&limit=100&offset=0');
        if (!res.ok) return;
        const data = await res.json();
        const items = data.items || [];
        sel.innerHTML = '<option value="">Selecione um an√∫ncio...</option>';
        items.forEach(it => {
          const opt = document.createElement('option');
          opt.value = it.id;
          opt.textContent = (it.title || it.id).substring(0, 60) + (it.title && it.title.length > 60 ? '...' : '');
          sel.appendChild(opt);
        });
      } catch (e) {
        sel.innerHTML = '<option value="">Erro ao carregar an√∫ncios</option>';
      }
    }

    async function loadCompetitors() {
      const listEl = document.getElementById('competitors-list');
      try {
        const res = await authFetch(API_BASE + '/api/ml/competitors');
        if (!res.ok) return;
        const data = await res.json();
        const items = data.items || [];
        if (items.length === 0) {
          listEl.innerHTML = '<p style="color: var(--gray);">Nenhum concorrente cadastrado. Adicione pelo link ou ID acima.</p>';
          return;
        }
        listEl.innerHTML = items.map(it => {
          const link = it.permalink || 'https://produto.mercadolivre.com.br/' + (it.item_id || '');
          const title = (it.nickname || it.title || it.item_id || '').substring(0, 70);
          const price = it.price != null ? formatPrice(it.price) : '‚Äî';
          const sold = it.sold_quantity != null ? it.sold_quantity : '‚Äî';
          return '<div class="result-row">' +
            (it.thumbnail ? '<img class="thumb" src="' + fixImageUrl(it.thumbnail) + '" alt="">' : '') +
            '<div class="info" style="flex:1;">' +
              '<a href="' + link + '" target="_blank" rel="noopener" style="color: var(--primary);">' + (title || it.item_id) + '</a>' +
              '<div style="margin-top: 0.25rem;"><span class="price">' + price + '</span> ' +
              (sold !== '‚Äî' ? '<span class="badge">' + sold + ' vendidos</span>' : '') + '</div>' +
            '</div>' +
            '<button type="button" class="btn-concorrentes" style="background: #dc2626;" data-item-id="' + (it.item_id || '') + '">Remover</button>' +
          '</div>';
        }).join('');
        listEl.querySelectorAll('button[data-item-id]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-item-id');
            if (!id || !confirm('Remover este concorrente?')) return;
            try {
              const r = await authFetch(API_BASE + '/api/ml/competitors/' + encodeURIComponent(id), { method: 'DELETE' });
              if (r.ok) loadCompetitors();
              else alert((await r.json()).detail || 'Erro ao remover.');
            } catch (e) { alert('Erro ao remover.'); }
          });
        });
      } catch (e) {
        listEl.innerHTML = '<p style="color: #dc2626;">Erro ao carregar concorrentes.</p>';
      }
    }

    async function addCompetitor() {
      const input = document.getElementById('competitor-url-input');
      const msg = document.getElementById('competitor-add-msg');
      const val = (input.value || '').trim();
      if (!val) {
        msg.textContent = 'Informe a URL ou o ID do an√∫ncio.';
        msg.style.color = '#dc2626';
        return;
      }
      const isUrl = /^https?:\/\//i.test(val);
      const body = isUrl ? { url: val } : { item_id: val };
      msg.textContent = 'Adicionando...';
      msg.style.color = '';
      try {
        const res = await authFetch(API_BASE + '/api/ml/competitors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          msg.textContent = data.detail || 'Erro ao adicionar.';
          msg.style.color = '#dc2626';
          return;
        }
        msg.textContent = data.message || 'Concorrente adicionado.';
        msg.style.color = '#059669';
        input.value = '';
        loadCompetitors();
      } catch (e) {
        msg.textContent = 'Erro de conex√£o.';
        msg.style.color = '#dc2626';
      }
    }

    async function doSearch(offset = 0) {
      const q = document.getElementById('search-input').value.trim();
      if (!q || q.length < 2) {
        alert('Digite pelo menos 2 caracteres para buscar.');
        return;
      }
      const sort = document.getElementById('sort-select').value || undefined;
      const btn = document.getElementById('btn-search');
      btn.disabled = true;
      document.getElementById('compare-results-area').style.display = 'none';
      document.getElementById('results-area').style.display = 'block';
      document.getElementById('results-list').innerHTML = '<p>Buscando...</p>';

      try {
        let url = `${API_BASE}/api/ml/search?q=${encodeURIComponent(q)}&limit=${limit}&offset=${offset}`;
        if (sort) url += '&sort=' + encodeURIComponent(sort);
        const res = await authFetch(url);
        if (res.status === 403) {
          const err = await res.json().catch(() => ({}));
          if (err.detail === 'ml_not_connected') document.getElementById('ml-not-connected').style.display = 'block';
          else document.getElementById('upgrade-required').style.display = 'block';
          document.getElementById('concorrentes-container').style.display = 'none';
          return;
        }
        if (res.status === 403 || res.status === 503) {
          const errData = await res.json().catch(() => ({}));
          const msg = errData.detail || 'A busca est√° restrita para este app.';
          
          // Log do erro para diagn√≥stico (pode remover depois)
          console.error('[ML Search] Erro na busca:', {
            status: res.status,
            detail: errData.detail,
            timestamp: new Date().toISOString()
          });
          
          // Identifica o tipo de erro para mostrar √≠cone apropriado
          let icon = '‚ö†Ô∏è';
          let title = 'Busca por termo indispon√≠vel';
          if (msg.includes('429') || msg.includes('Limite de requisi√ß√µes')) {
            icon = '‚è±Ô∏è';
            title = 'Limite de requisi√ß√µes atingido';
          } else if (msg.includes('500') || msg.includes('servidor')) {
            icon = 'üîß';
            title = 'Erro tempor√°rio no servidor ML';
          }
          
          document.getElementById('results-list').innerHTML = `
            <div class="card" style="padding: 1.5rem;">
              <p style="font-size: 2rem; margin: 0;">${icon}</p>
              <p><strong>${title}</strong></p>
              <p style="margin-top: 0.5rem; color: var(--gray);">${msg.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>')}</p>
              <p style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                üí° <strong>Solu√ß√£o:</strong> Use <strong>Adicionar concorrente por link ou ID</strong> no topo da p√°gina para acompanhar concorrentes pelo link do an√∫ncio.
              </p>
            </div>`;
          btn.disabled = false;
          return;
        }
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.detail || 'Erro na busca');
        }
        const data = await res.json();
        const results = data.results || [];
        const paging = data.paging || {};
        const total = paging.total || 0;

        document.getElementById('results-meta').textContent = `Encontrados ${total} an√∫ncios para "${q}"`;

        if (results.length === 0) {
          document.getElementById('results-list').innerHTML = '<p style="color: var(--gray);">Nenhum resultado encontrado.</p>';
        } else {
          document.getElementById('results-list').innerHTML = results.map((r, i) => {
            const pos = offset + i + 1;
            const thumb = r.thumbnail || '';
            const price = formatPrice(r.price);
            const sold = r.sold_quantity || 0;
            const link = r.permalink || `https://produto.mercadolivre.com.br/${r.id}`;
            return `
              <div class="result-row">
                <span class="pos">#${pos}</span>
                ${thumb ? `<img class="thumb" src="${fixImageUrl(thumb)}" alt="">` : ''}
                <div class="info">
                  <a href="${link}" target="_blank" style="color: var(--primary); text-decoration: none;">${r.title || 'Sem t√≠tulo'}</a>
                  <div style="margin-top: 0.25rem;">
                    <span class="price">${price}</span>
                    ${sold > 0 ? `<span class="badge" style="margin-left: 0.5rem;">${sold} vendidos</span>` : ''}
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        const pagEl = document.getElementById('results-pagination');
        if (total > limit) {
          const pages = Math.ceil(total / limit);
          const page = Math.floor(offset / limit) + 1;
          let html = '';
          if (page > 1) {
            html += `<button onclick="doSearch(${offset - limit})" class="button" style="margin-right: 0.5rem;">Anterior</button>`;
          }
          html += `<span style="margin: 0 1rem;">P√°gina ${page} de ${pages}</span>`;
          if (page < pages) {
            html += `<button onclick="doSearch(${offset + limit})" class="button" style="margin-left: 0.5rem;">Pr√≥xima</button>`;
          }
          pagEl.innerHTML = html;
        } else {
          pagEl.innerHTML = '';
        }
      } catch (e) {
        console.error('[ML Search] Exce√ß√£o capturada:', {
          message: e.message,
          stack: e.stack,
          timestamp: new Date().toISOString()
        });
        
        document.getElementById('results-list').innerHTML = `
          <div style="padding: 1rem; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
            <p style="color: #dc2626; margin: 0;"><strong>‚ùå Erro ao buscar</strong></p>
            <p style="color: #991b1b; margin: 0.5rem 0 0 0; font-size: 0.9rem;">${e.message || 'Erro desconhecido. Tente novamente.'}</p>
            <p style="color: #6b7280; margin: 0.5rem 0 0 0; font-size: 0.85rem;">üí° Verifique sua conex√£o ou tente adicionar concorrente por link/ID.</p>
          </div>`;
      }
      btn.disabled = false;
    }

    async function doCompare() {
      const itemId = document.getElementById('my-items-select').value;
      if (!itemId) {
        alert('Selecione um an√∫ncio para comparar.');
        return;
      }
      const btn = document.getElementById('btn-compare');
      btn.disabled = true;
      document.getElementById('results-area').style.display = 'none';
      document.getElementById('compare-results-area').style.display = 'block';
      document.getElementById('compare-list').innerHTML = '<p>Comparando...</p>';

      try {
        const res = await authFetch(`${API_BASE}/api/ml/compare/${itemId}`);
        if (res.status === 403) {
          document.getElementById('ml-not-connected').style.display = 'block';
          btn.disabled = false;
          return;
        }
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          const msg = (errData.detail || (res.status === 503 ? 'A compara√ß√£o na busca exige certifica√ß√£o do app no ML.' : 'Erro na compara√ß√£o')).replace(/\*\*/g, '');
          document.getElementById('compare-title').textContent = 'Compara√ß√£o';
          document.getElementById('compare-summary').innerHTML = '<p style="color: #dc2626;">' + msg + '</p><p style="margin-top: 0.75rem;">Compare pre√ßos e vendidos na lista <strong>Meus concorrentes cadastrados</strong> (adicione concorrentes pelo link no topo).</p>';
          document.getElementById('compare-list').innerHTML = '';
          btn.disabled = false;
          return;
        }
        const data = await res.json();
        const { my_item, results, search_term, user_position, total_results, in_top_50 } = data;

        document.getElementById('compare-title').textContent = my_item.title || my_item.id;

        let summary = `Termo de busca: "${search_term}". Total de an√∫ncios: ${total_results}.`;
        if (user_position !== null) {
          summary += ` Seu an√∫ncio est√° na posi√ß√£o <strong>#${user_position}</strong> entre os primeiros resultados.`;
        } else {
          summary += ` Seu an√∫ncio n√£o aparece nos primeiros 50 resultados desta busca.`;
        }
        document.getElementById('compare-summary').innerHTML = summary;

        const myPrice = my_item.price || 0;
        const prices = results.map(r => r.price || 0).filter(p => p > 0);
        const avgPrice = prices.length ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
        const priceDiff = myPrice && avgPrice ? ((myPrice - avgPrice) / avgPrice * 100).toFixed(1) : null;

        let listHtml = '';
        if (priceDiff !== null) {
          listHtml += `<p style="margin-bottom: 1rem;">Seu pre√ßo: <strong>${formatPrice(myPrice)}</strong>. Pre√ßo m√©dio dos concorrentes: ${formatPrice(avgPrice)}. ${parseFloat(priceDiff) > 0 ? 'Voc√™ est√° acima da m√©dia em ' + priceDiff + '%.' : 'Voc√™ est√° abaixo da m√©dia em ' + Math.abs(parseFloat(priceDiff)) + '%.'}</p>`;
        }

        listHtml += results.map((r, i) => {
          const pos = i + 1;
          const isMine = r.id === itemId;
          const thumb = r.thumbnail || '';
          const price = formatPrice(r.price);
          const sold = r.sold_quantity || 0;
          const link = r.permalink || `https://produto.mercadolivre.com.br/${r.id}`;
          return `
            <div class="result-row ${isMine ? 'mine' : ''}">
              <span class="pos">#${pos}</span>
              ${thumb ? `<img class="thumb" src="${fixImageUrl(thumb)}" alt="">` : ''}
              <div class="info">
                ${isMine ? '<span class="badge">Seu an√∫ncio</span> ' : ''}
                <a href="${link}" target="_blank" style="color: var(--primary); text-decoration: none;">${r.title || 'Sem t√≠tulo'}</a>
                <div style="margin-top: 0.25rem;">
                  <span class="price">${price}</span>
                  ${sold > 0 ? `<span class="badge" style="margin-left: 0.5rem;">${sold} vendidos</span>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

        document.getElementById('compare-list').innerHTML = listHtml;
      } catch (e) {
        document.getElementById('compare-list').innerHTML = '<p style="color: red;">' + (e.message || 'Erro ao comparar. Verifique se o an√∫ncio est√° ativo e tente novamente.') + '</p>';
      }
      btn.disabled = false;
    }

    async function init() {
      await initClerkAuth({ signInContainerId: 'clerk-signin', userButtonContainerId: 'clerk-user-button', appContentId: 'app-content' });
      if (!window.ClerkAuth?.signedIn) return;
      setupConectarMlButton();
      const ok = await checkAccess();
      if (!ok) return;

      document.getElementById('btn-add-competitor').addEventListener('click', addCompetitor);
      document.getElementById('btn-search').addEventListener('click', () => doSearch(0));
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') doSearch(0);
      });
      document.getElementById('btn-compare').addEventListener('click', doCompare);
    }

    init();
  </script>
</body>
</html>
